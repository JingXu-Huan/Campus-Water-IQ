# 虚拟水表与水质检测设备开发手册(轻量级数字孪生)

## 一、编写目的

- 本手册用于指导校园水务系统中**虚拟水表与水质检测仪设备模块**的设计与开发。
- 在缺乏真实硬件设备接入条件的情况下，通过软件方式模拟水表与水质传感器的运行行为，实现数据上报、存储与分析验证，为后续真实设备接入提供标准化接口与逻辑基础。

本模块属于**设备侧模拟层**，并非业务统计或展示模块。

---

## 二、设计原则

1. **工程真实性原则**：模拟真实水表与水质检测设备的上报行为与数据特征，非简单随机数生成。
2. **解耦原则**：虚拟设备模块与业务服务解耦，可独立启停。
3. **可替换原则**：后期真实设备接入时，仅替换数据来源，不影响业务逻辑。
4. **可解释原则**：设备行为与数据变化规律应符合常识，便于答辩与说明。

---

## 三、虚拟设备类型说明

### 3.1 虚拟水表（`Water Meter Simulator`）

模拟内容包括：

- 瞬时流量（Flow Rate，m³/h）
- 累计用水量（Total Usage，m³）
- 管网水压（Pressure，MPa）
- 水温（Water Temperature，℃）
- 阀门状态（开启 / 关闭 / 故障）
- 设备运行状态（正常 / 离线 / 异常）

说明：

- **水压**用于反映管网运行工况，可用于模拟爆管、供水不足等场景
- **水温**在教学项目中主要用于丰富数据维度，体现真实设备采集能力
- **阀门状态**可用于联动控制与运维演示（如远程关阀）

### 3.2 虚拟水质检测仪（`Water Quality Sensor Simulator`）

模拟内容包括：
- pH 值
- 浊度（NTU）
- 余氯（mg/L）
---

## 四、设备运行模型设计

### 4.1 设备与楼宇绑定关系

- 一个楼宇配置多个虚拟水表
- 水质检测仪按楼宇或管网节点配置

同时，系统采用**统一设备编码规则**以体现设备类型、楼宇与房间的层级关系：

- 设备编号（id）格式：`ABCXYZZZ`
- `A`：设备类型标识（`1` 表示水表，`2` 表示水质/压力等传感器）
- `BC`：楼宇编号（`01`–`99`）
- `XY`：楼宇层数（如 `10` 表示 10 层楼，`20` 表示 20 层楼）
- `ZZZ`：房间或用水单元编号（宿舍房间、功能分区等）

特殊规则说明：

- 每栋楼**每层配置 1 台传感器**
- 因此，**传感器类设备的编号后缀固定为 **001**，用于表示该层公共监测点

示例说明：

- `10110001`：水表（1），01 号楼，10 层建筑，第 001 号房间
- `10120018`：水表（1），01 号楼，20 层建筑，第 018 号房间
- `20110001`：传感器（2），01 号楼，10 层建筑，第 001 号监测点

---

### 4.2 数据上报时间策略

| 设备类型 | 上报内容         | 建议周期     |
|------|--------------|----------|
| 水表   | 瞬时流量         | 30 秒     |
| 水表   | 累计用水量        | 5 分钟     |
| 水质仪  | pH / 浊度 / 余氯 | 5\~10 分钟 |

---

## 五、数据生成逻辑说明

### 5.1 用水行为模拟逻辑

虚拟水表用水量应满足以下规律：

- 白天（6:00–22:00）用水量高于夜间
- 夜间小流量可模拟管道漏水
- 不发送数据可模拟离线
- 不同楼宇用水基准值不同（宿舍 > 教学楼 > 办公楼）
- 累计用水量随时间单调递增
- 可配置小概率异常波动（突增 / 断流）

### 5.2 水质参数模拟范围（参考）

| 参数 | 正常范围            |
|----|-----------------|
| pH | 6.5 – 8.5       |
| 浊度 | ≤ 1.0 NTU       |
| 余氯 | 0.05 – 0.5 mg/L |

异常状态可通过超出阈值触发。

---

## 六、数据结构定义

### 6.1 水表上报数据结构

```json
{
  "Device": 1,
  "DeviceId": "10110001",
  "timestamp": "2025-12-20T10:30:00",
  "flow": 1.8,
  "totalUsage": 245.6,
  "pressure": 0.4,
  "waterTem": 20.5,
  "IsOpen": "normal",
  "status": "normal"
}
```

### 6.2 水质检测数据结构

```json
{
  "Device": 2,
  "DeviceId": "20110001",
  "timestamp": "2025-12-20T10:30:00",
  "ph": 7.2,
  "turbidity": 0.8,
  "chlorine": 0.25,
  "status": "normal"
}

```

---

## 七、后端实现建议

### 7.1 定时任务实现

- 使用 `@Scheduled` 注解
- 每次任务生成一批虚拟设备数据
- 写入消息队列，由下游消费者处理数据

### 7.2 模块划分建议

- simulator 层：虚拟设备数据生成
- ingest 层：数据接入与校验（可选）

---

## 八、异常与告警模拟

- 用水突增：流量瞬时升高 2–5 倍
- 断流：流量为 0
- 水质异常：参数超阈值

异常可按概率触发（如 1%–5%）。
## 九、与前端的交互：
- 前端传入楼宇数量，楼层数量，每层房间号后。由此服务注册设备。
- 前端可以控制虚拟设备上报的数据异常情况。例如将某台虚拟设备的水压调高。
- 前端可以控制设备的运行状况等等。
<br/>
详见前端的原型图。
---

