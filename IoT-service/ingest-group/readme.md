# 数据接入层开发手册

## 一、模块职责

数据接入层是物联网数据链路中的第一道“工程防线”，负责在**高并发、弱可信数据源**的前提下，保障数据的可用性、可追溯性与基础可信度。

本模块主要职责如下：

1. 接收来自 `Iot-device` 微服务的设备上报数据，并进行**原始数据持久化**。
2. 将校验后的有效数据，**合理存储至时序数据库**，支撑后续分析与展示。
3. 支持**轻量级规则判断**，对易于识别的异常数据进行快速发现。
4. 对明显异常或非法数据进行**过滤与隔离**，必要时**通知告警服务**。

------

## 二、已完成内容

目前已完成以下能力：

- 已成功接入 `Iot-device` 微服务的数据流。
- 实现设备原始数据的持久化存储（**没做幂等**），用于问题追溯与数据回放。

------

## 三、数据接入方式

### 3.1 接入方式说明

​	数据通过 **消息队列（MQ）** 方式进行异步解耦传输，数据接入层仅关注消费与处理，不直接感知设备侧通信协议。

### 3.2 Topic 与消费者组约定

#### 水表数据

- Topic：`Meter-Data`
- Consumer Group：`Meter-Data-ConsumerGroup`

#### 水质传感器数据

- Topic：`WaterQuality-Data`
- Consumer Group：`WaterQuality-Data-ConsumerGroup`

> 约定说明：
>
> - 一个消费者组只负责一类设备数据，避免语义混乱。
> - Consumer Group 命名需体现业务含义，禁止使用临时或测试命名。

------

## 四、数据校验与过滤规范

### 4.1 基础校验规则

以下校验为**强制校验**：

- 设备唯一标识不能为空
- 数据上报时间戳不能为空
- 时间戳需在合理区间内（允许一定程度的时钟漂移）
- 数值字段必须符合类型定义（禁止 NaN、Infinity 等非法值）

### 4.2 物理合理性校验（示例）

- 水温应处于合理区间
- 水压不可为负值
- 流量突变需在可配置阈值内

### 4.3 校验失败处理策略

- 校验失败的数据：
    - **一定不能进入时序数据库**
    - 可选择性存储至原始数据表或冷存储
- 严重异常数据：
    - 触发告警消息，通知告警服务。
    - 记录完整上下文日志，便于排查。

> 核心原则：不丢真相，但不污染主数据。

------

## 五、异常规则判断定位

### 5.1 规则判断边界

数据接入层仅处理**低复杂度、强确定性**规则：（在本层处理，数据少一跳，性能更高）

- 明显越界（如超过物理极限）
- 明显突变（瞬时大幅偏移）
- 明显不可能（负流量、非法状态）

### 5.2 不在本层处理的规则

以下规则不应在数据接入层实现：（这些重量级的分析放在专门的service层）

- 跨设备关联分析
- 长时间窗口统计分析
- 复杂业务语义判断

> 接入层负责“发现异常的影子”，而不是“解释异常的人生”。

------

## 六、告警服务通知规范

### 6.1 通知方式

通过消息队列向告警服务发送异常消息。

### 6.2 告警 Topic 约定

- 异常水流量：`error-flow`
- 异常水温：`error-tem`
- 异常水压力：`error-pres`

> 可根据业务扩展新的告警 Topic，但需统一命名规范。

### 6.3 告警消息内容要求

告警消息应至少包含：

- 设备唯一标识（`deviceCode`）
- 异常类型
- 异常时间
- 原始数值
- 判定规则标识

------

## 七、消息消费设计约定

### 7.1 幂等性要求

- 同一设备 + 同一时间戳的数据应具备天然唯一性
- 重复消费不得造成数据重复写入或状态污染

### 7.2 消费失败处理

- 业务异常与系统异常需区分处理
- 可重试异常进入重试机制
- 不可重试异常需记录日志并上报监控

### 7.3 顺序性说明

- 不依赖全局消息顺序
- 单设备数据应尽量保持时间有序（依赖 MQ 分区策略）

------

## 八、时序数据库写入规范

### 8.1 时间字段规范

- 主时间字段使用设备上报时间
- 服务端接收时间仅作辅助参考
- 明确时间精度（秒 / 毫秒），避免混用

### 8.2 标签与字段设计

- 标签（Tag）：
    - 设备 ID
    - 设备类型
- 字段（Field）：
    - 传感器数值

> 禁止在时序数据库中存放高频变化的字符串描述字段。

### 8.3 数据生命周期管理

- 明确热数据、冷数据、归档数据保留周期
- 支持定期降采样，降低存储与查询成本

------

## 九、可观测性与运维要求

### 9.1 必须暴露的监控指标

- 消费失败次数
- 数据校验失败比例
- 告警消息发送成功率

### 9.2 日志规范

- 日志必须可定位到：
    - 设备
    - 时间
    - Topic
    - 异常原因
- 禁止无意义日志堆叠

> 一个好的系统，应该在凌晨三点依然能被人类理解。

------

### 十、数据取值范围

这里描述`IoT-device`微服务为你提供的合理数据取值范围：(**即超出此范围的数据，要报送告警服务。不要写入时序数据库**)

范围均为左闭右闭。

水表：

```
device:1
flow: [0,0.35]
tem:[4,27]
pres:[Pmin(从nacos设置),Pmax(从nacos设置)]
isOpen:{"normal","closed"}
totalUsage:[0,INF]
//数据状态
status:{"normal","error"}
```

水质传感器：

```
device:2
ph:[6.8,8.0]
turbidty:[0.1,1.0]
Chlorine:[0.22,0.9]
status:{"normal","error"}
```

