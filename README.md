# 基于微服务架构的——校园水务数字孪生与智能分析平台

# 系统架构设计文档

## 一、项目背景与建设目标

随着高校校园规模的不断扩大，用水设施分布广、类型多，传统人工抄表和事后处理方式已无法满足精细化管理需求。校园用水过程中普遍存在以下问题：

- 用水数据获取滞后，无法实时掌握水量与水质情况
- 漏水、爆管等异常无法及时发现，造成水资源浪费
- 缺乏对历史数据的系统分析，难以支撑节水决策

### 本项目目标

本项目基于 **`Java` 微服务架构**，融合 **`IoT` 设备接入、时序数据分析、异常检测与 AI 预测分析** 技术，构建一套面向校园场景的 **智慧用水监测与决策平台**，实现：

- 用水数据的实时采集与统一管理
- 校园用水行为分析与异常智能识别
- 告警闭环管理与多角色可视化展示
- 为高校节水管理与运维决策提供数据支撑

## 二、总体技术架构设计

### 架构风格

- 微服务架构（`Spring Boot / Spring Cloud`）
- 服务解耦、按职责拆分
- 支持横向扩展与模块独立演进

### 系统整体架构

```Plain
IoT 设备 / 模拟设备
        ↓
设备接入服务（WebSocket / Netty）
        ↓
Redis（临时缓存）
        ↓
消息队列（Kafka / RocketMQ）
        ↓
数据分析服务（规则 + AI + InfluxDB）
        ↓
 ┌──────────────┐
 │              │
告警通知服务   可视化服务
 │              │
通知渠道       前端系统
```

## 三、微服务模块设计

### 1. 设备接入服务（`IoT` 接入服务）

#### 1.1 服务职责

- **开发 / 测试阶段**
  - 使用 `Java` 微服务模拟校园水表、传感器设备
  - 生成随机水量、水质数据发送到数据分析服务
- **生产环境**
  - 对接真实智能水表或传感设备
  - 支持海量设备并发接入
- 基于 **长连接 / 定时推送机制（`WebSocket`）** 接收数据
- 对设备数据进行：
  - 合法性校验
  - 异常值过滤
  - 统一格式化（数据清洗）
- 将数据写入 `Redis` 缓存，并通过消息队列异步发送至数据分析服务

#### 1.2 创新设计点

**（1）设备数字孪生模型**

- 在系统中为每个物理设备维护一个数字孪生对象
- 实时映射设备运行状态：
  - 当前流量
  - 累计用水量
  - 水质指标
  - 在线 / 离线状态
- 为后续数据分析、异常识别和预测分析提供统一抽象模型

**（2）可插拔设备接入适配层**

- 抽象统一的设备接入接口
- 支持多种接入方式：
  - `WebSocket`（模拟设备）
  - `TCP / UDP`（真实设备）
  - `HTTP Push`（低成本设备）
- 实现设备接入方式的可扩展与低耦合

**（3）边缘数据校验与可信标记**

- 在接入层完成初步异常识别
- 为数据打上可信标签（正常 / 可疑 / 异常）
- 异常数据记录日志并上报，为后续告警提供依据

#### 1.3 技术实现

- `Netty` + `WebSocket` 实现设备长连接
- `Spring Boot` 构建设备管理 `REST API`
- `Redis` 作为临时缓存与数据缓冲
- `Kafka` / `RocketMQ` 异步解耦后续处理

### 2. 数据分析服务（核心业务服务）

#### 2.1 服务职责

- 接收 `IoT` 设备上报的数据流
- 对设备数据进行多维度统计分析，包括但不限于：
  - 瞬时流量、累计用水量
  - 用水高峰时段、夜间异常用水量
  - 用水增长率 / 环比变化率
  - 区域用水占比、单位面积用水量
  - 设备离线率、设备健康度评分
  - 水质合格率、节水率、用水波动指数
- 支持多种异常检测场景：
  - 漏水异常
  - 停水异常
  - 水管爆裂异常
  - 突发高流量异常
- 异常事件实时推送至告警通知服务
- 调用 AI 大模型进行趋势预测与综合分析

#### 2.2 创新设计点

**（1）规则引擎 + AI 双重异常检测机制**

- 规则引擎：
  - 基于阈值、时间窗口的实时检测
- AI 异常检测：
  - 学习历史用水行为模式
  - 识别复杂、非规则型异常

**（2）校园用水行为画像建模**

- 按区域构建用水画像：
  - 宿舍区
  - 教学楼
  - 实验室
- 分析不同场景下的用水规律与变化趋势

**（3）AI 用水预测与节水建议生成**

- 基于历史数据预测未来用水趋势
- 自动生成节水与管理优化建议

#### 2.3 技术实现

- `Kafka / RocketMQ` 解耦数据流
- `InfluxDB` 存储时序数据
- `Spring` 定时任务 / 流式计算完成指标统计
- 基于 `LangChain4j` 调用 AI 大模型

#### 2.4 数据存储设计

与系统统一数据架构保持一致，详见数据设计章节。

### 3. 告警通知服务

#### 3.1 服务职责

- 监听数据分析服务异常事件
- 按告警等级触发多渠道通知：
  - 短信
  - 邮件
  - 企业微信
  - `APP` 推送
- 管理告警全生命周期

#### 3.2 创新设计点

**（1）告警分级与风险评分机制**

- 根据异常严重程度自动分级
- 时间窗口内告警压缩，避免告警风暴

**（2）告警闭环管理机制**

触发 → 已通知 → 已确认 → 处理中 → 已解决

#### 3.3 技术实现

- `RocketMQ` 异步接收异常事件
- 集成第三方通知接口
- `Spring Boot` 提供告警管理 `API`

### 4. 可视化服务（前后端分离）

#### 4.1 服务职责

- 提供统一 `REST API`
- 聚合分析数据、告警数据、设备状态
- 支撑实时监控与历史分析展示

#### 4.2 创新设计点

- 多角色可视化视图（管理员 / 后勤 / 学生）
- 校园用水态势感知大屏
- `WebSocket` 实时数据推送

#### 4.3 技术实现

- 后端：`Spring Boot`
- 前端：`Vue / React + ECharts`
- `Redis` 缓存热点数据

### 5. 用户与权限服务（可选）

- 用户、角色、权限管理
- 统一认证与鉴权
- 技术实现：
  - `Spring Security`
  - `JWT / OAuth2`
  - `MySQL`
  - `Spring Cloud Alibaba`

## 四、项目创新点总结（重点）

1. **面向校园场景的 `Java` 微服务智慧水务平台架构设计** 以微服务架构为核心，围绕设备接入、数据分析、告警管理与可视化展示进行模块化拆分，实现系统高内聚、低耦合，具备良好的可扩展性与工程落地能力。
2. **设备数字孪生与多协议 `IoT` 接入模型** 在系统层面构建设备数字孪生模型，实现物理设备与虚拟模型的实时映射；通过可插拔接入适配层，支持多协议、多类型设备统一接入，降低设备接入成本。
3. **规则引擎 + AI 的双重异常检测机制** 结合传统规则引擎的实时性与 AI 模型的学习能力，实现对规则型与非规则型异常的协同识别，有效提升异常检测准确率与覆盖范围。
4. **校园用水行为画像与智能预测分析** 按区域、场景构建校园用水行为画像，挖掘不同场景下的用水规律；基于历史数据进行用水趋势预测，并生成节水与运维优化建议。
5. **告警闭环管理与多角色可视化决策支持** 构建完整告警生命周期管理机制，结合多角色可视化展示，为管理人员提供直观、可操作的决策支持能力。

## 五、可行性与推广价值

- 技术体系成熟，工程实现路径清晰
- 场景真实，贴合高校智慧校园建设需求
- 架构具备良好扩展性，可推广至智慧园区、智慧社区等场景
