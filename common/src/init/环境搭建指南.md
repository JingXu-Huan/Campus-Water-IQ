# 开发人员环境搭建指南

该手册将指导如何搭建后端开发环境。

## 先决条件

- **操作系统**：Linux/Windows
- **内存**：至少 8G，推荐 16G
- **CPU**：至少 4 核心
- **Docker**：已安装并运行
- **Nacos，MQ**:已经在远程部署
- **Docker Compose**：推荐安装（可选）

## Linux 环境部署指南

### Docker 部署

#### 1. Redis

```bash
sudo docker run -d \
    --name redission \
    -p 36379:6379 \
    redis:7
```

#### 2. Redis主缓存

```bash
sudo docker run -d \
    --name redis \
    -p 6379:6379 \
    redis:7
```

#### 3. MySQL

```bash
sudo docker run -d \
    --name mysql \
    --hostname=mysql \
    --env=MYSQL_ROOT_PASSWORD=123456 \
    --env=MYSQL_DATABASE=water \
    -v mysql_data:/var/lib/mysql \
    -p 3306:3306 \
    --network=bridge \
    mysql:8.0
```

#### 4. Canal（数据同步）

```bash
sudo docker run -d \
    --name canal \
    --hostname=canal \
    --env=canal.instance.master.address=host.docker.internal:3306 \
    --env=canal.instance.dbUsername=canal \
    --env=canal.instance.dbPassword=canal \
    --env=canal.instance.connectionCharset=UTF-8 \
    --env=canal.instance.filter.regex=.*\\..* \
    --network=bridge \
    -p 11111:11111 \
    canal/canal-server:latest
```

#### 5. InfluxDB（时序数据库）

```bash
sudo docker run -d \
    --name influxdb \
    --hostname=influxdb \
    --env=DOCKER_INFLUXDB_INIT_USERNAME=jingxu \
    --env=DOCKER_INFLUXDB_INIT_PASSWORD=jingxu202430904 \
    --env=DOCKER_INFLUXDB_INIT_ORG=ncwu \
    --env=DOCKER_INFLUXDB_INIT_BUCKET=water \
    --env=DOCKER_INFLUXDB_INIT_MODE=setup \
    --network=bridge \
    -v influxdb_data:/var/lib/influxdb2 \
    -p 8086:8086 \
    influxdb:2
```

### 配置说明

#### InfluxDB Token 配置

1. 访问 InfluxDB Web 界面：`http://127.0.0.1:8086`
2. 使用凭据登录：
   - **用户名**：jingxu
   - **密码**：jingxu202430904
3. 生成访问令牌（Token）
4. 在 `IoT-service/ingest-group/src/main/resources/application.yml` 中更新 token

#### 数据库初始化

执行 SQL 脚本初始化数据库：

```bash
# 使用 MySQL 客户端
mysql -h 127.0.0.1 -P 3306 -u root -p123456 < common/src/sql/sql.sql
```

---

## Windows 环境部署指南

### 前置要求

- 安装 [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/)
- 确保已启动 WSL 2 支持

### Docker 部署

#### 1. Redis（主缓存）

```powershell
docker run -d `
    --name redission `
    -p 36379:6379 `
    redis:7
```

#### 2. Redis（会话存储）

```powershell
docker run -d `
    --name redis `
    -p 6379:6379 `
    redis:7
```

#### 3. MySQL

```powershell
docker run -d `
    --name mysql `
    --hostname=mysql `
    --env=MYSQL_ROOT_PASSWORD=123456 `
    --env=MYSQL_DATABASE=water `
    -v mysql_data:/var/lib/mysql `
    -p 3306:3306 `
    --network=bridge `
    mysql:8.0
```

#### 4. Canal（数据同步）

```powershell
docker run -d `
    --name canal `
    --hostname=canal `
    --env=canal.instance.master.address=host.docker.internal:3306 `
    --env=canal.instance.dbUsername=canal `
    --env=canal.instance.dbPassword=canal `
    --env=canal.instance.connectionCharset=UTF-8 `
    --env=canal.instance.filter.regex=.*\\..* `
    --network=bridge `
    -p 11111:11111 `
    canal/canal-server:latest
```

#### 5. InfluxDB（时序数据库）

```powershell
docker run -d `
    --name influxdb `
    --hostname=influxdb `
    --env=DOCKER_INFLUXDB_INIT_USERNAME=jingxu `
    --env=DOCKER_INFLUXDB_INIT_PASSWORD=jingxu202430904 `
    --env=DOCKER_INFLUXDB_INIT_ORG=ncwu `
    --env=DOCKER_INFLUXDB_INIT_BUCKET=water `
    --env=DOCKER_INFLUXDB_INIT_MODE=setup `
    --network=bridge `
    -v influxdb_data:/var/lib/influxdb2 `
    -p 8086:8086 `
    influxdb:2
```

### 配置说明

#### InfluxDB Token 配置

1. 访问 InfluxDB Web 界面：`http://localhost:8086`
2. 使用凭据登录：
   - **用户名**：jingxu
   - **密码**：jingxu202430904
3. 生成访问令牌（Token）
4. 在 `IoT-service/ingest-group/src/main/resources/application.yml` 中更新 token

#### 数据库初始化

使用 MySQL 客户端工具（如 MySQL Workbench、HeidiSQL 等）或命令行：

```cmd
mysql -h 127.0.0.1 -P 3306 -u root -p123456 < common\src\sql\sql.sql
```

---

## 验证部署

### 检查容器状态

```bash
# Linux/Windows PowerShell
docker ps

# 应该看到以下容器运行：
# - redis-cache
# - redis-session  
# - mysql
# - canal
# - influxdb
```

### 端口检查

| 服务           | 端口    | 用途         |
|--------------|-------|------------|
| Redis (分布式锁) | 36379 | redission锁 |
| Redis (主缓存)  | 6379  | 主缓存        |
| MySQL        | 3306  | 关系型数据库     |
| Canal        | 11111 | 数据同步       |
| InfluxDB     | 8086  | 时序数据库      |

---

## 常见问题

### 1. 端口冲突
如果端口被占用，可以修改 `-p` 参数映射到其他端口

### 2. 容器启动失败
检查 Docker 是否正常运行，端口是否被占用

### 3. 数据持久化
使用 Docker volumes 确保数据持久化，容器重启后数据不丢失